<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>{% block title %}AI Fitness Coach{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Application de coaching sportif personnalis√© avec intelligence artificielle. Cr√©ez vos programmes d'entra√Ænement et suivez vos progr√®s.">
    <meta name="keywords" content="fitness, coaching, sport, IA, entra√Ænement, musculation">
    <meta name="author" content="AI Fitness Coach">
    <meta name="robots" content="index, follow">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('manifest') }}">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#F4A261">
    <meta name="msapplication-TileColor" content="#0D1B2A">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitnessAI">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="FitnessAI">
    
    <!-- Windows -->
    <meta name="msapplication-starturl" content="/">
    <meta name="msapplication-navbutton-color" content="#F4A261">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Preload important resources -->
    <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='sw.js') }}" as="script">
</head>
<body>
    <div class="container">
        {% block content %}{% endblock %}
    </div>
    
    <nav class="nav-bottom">
        <div class="nav-links">
            <a href="/" class="nav-link {% if request.endpoint == 'home' %}active{% endif %}">
                Accueil
            </a>
            <a href="/programme" class="nav-link {% if request.endpoint == 'programme' %}active{% endif %}">
                Programme
            </a>
            <a href="/ai" class="nav-link {% if request.endpoint == 'ai_coach' %}active{% endif %}">
                IA
            </a>
            <a href="/track" class="nav-link {% if request.endpoint == 'track_performance' %}active{% endif %}">
                S√©ances
            </a>
            <a href="/progress" class="nav-link {% if request.endpoint == 'view_progress' %}active{% endif %}">
                Perf
            </a>
        </div>
    </nav>

    <!-- PWA Installation Banner -->
    <div id="installBanner" class="install-banner" style="display: none;">
        <div class="install-content">
            <div class="install-icon">üì±</div>
            <div class="install-text">
                <h3>Installer l'application</h3>
                <p>Ajoutez AI Fitness Coach √† votre √©cran d'accueil pour une exp√©rience optimale</p>
            </div>
            <button id="installButton" class="btn btn-primary">Installer</button>
            <button id="dismissInstall" class="btn btn-secondary">Plus tard</button>
        </div>
    </div>

    <!-- PWA JavaScript -->
    <script>
        // Variables globales PWA
        let deferredPrompt;
        let installBanner = document.getElementById('installBanner');
        let installButton = document.getElementById('installButton');
        let dismissButton = document.getElementById('dismissInstall');

        // Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    
                    // V√©rifier les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateAvailable();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erreur Service Worker:', error);
                }
            });
        }

        // Gestion de l'installation PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üí° Prompt d\'installation PWA disponible');
            e.preventDefault();
            deferredPrompt = e;

            // V√©rifier si l'app n'est pas d√©j√† install√©e
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                showInstallBanner();
            }
        });

        // Afficher la banni√®re d'installation
        function showInstallBanner() {
            // Ne pas afficher si d√©j√† rejet√© r√©cemment
            if (localStorage.getItem('installDismissed')) {
                const dismissTime = parseInt(localStorage.getItem('installDismissTime'));
                const daysSince = (Date.now() - dismissTime) / (1000 * 60 * 60 * 24);
                if (daysSince < 7) return; // Attendre 7 jours
            }

            installBanner.style.display = 'block';
            setTimeout(() => {
                installBanner.classList.add('show');
            }, 1000);
        }

        // Installation de l'app
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;

            installBanner.style.display = 'none';
            deferredPrompt.prompt();

            const { outcome } = await deferredPrompt.userChoice;
            console.log('üéØ Choix utilisateur:', outcome);

            if (outcome === 'accepted') {
                console.log('‚úÖ PWA install√©e');
                localStorage.removeItem('installDismissed');
                localStorage.removeItem('installDismissTime');
            }

            deferredPrompt = null;
        });

        // Rejeter l'installation
        dismissButton.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('installDismissed', 'true');
            localStorage.setItem('installDismissTime', Date.now().toString());
        });

        // D√©tecter si l'app est lanc√©e en mode standalone
        window.addEventListener('DOMContentLoaded', () => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('üéâ Application lanc√©e en mode standalone');
                document.body.classList.add('standalone-mode');
                
                // Masquer les √©l√©ments non n√©cessaires en mode app
                const elements = document.querySelectorAll('.hide-in-app');
                elements.forEach(el => el.style.display = 'none');
            }
        });

        // Notification de mise √† jour disponible
        function showUpdateAvailable() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Mise √† jour disponible', {
                    body: 'Une nouvelle version d\'AI Fitness Coach est disponible.',
                    icon: '/static/icons/icon-192x192.svg',
                    badge: '/static/icons/icon-72x72.svg'
                });
            }
            
            // Ou afficher une banni√®re dans l'app
            const updateBanner = document.createElement('div');
            updateBanner.className = 'update-banner';
            updateBanner.innerHTML = `
                <div class="update-content">
                    <span>üîÑ Mise √† jour disponible</span>
                    <button onclick="window.location.reload()" class="btn btn-secondary btn-small">Actualiser</button>
                </div>
            `;
            document.body.insertBefore(updateBanner, document.body.firstChild);
        }

        // Gestion du mode hors ligne
        window.addEventListener('online', () => {
            console.log('üåê Connexion r√©tablie');
            document.body.classList.remove('offline');
            showToast('Connexion r√©tablie', 'success');
        });

        window.addEventListener('offline', () => {
            console.log('üì± Mode hors ligne');
            document.body.classList.add('offline');
            showToast('Mode hors ligne activ√©', 'info');
        });

        // Fonction utilitaire pour les toasts
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Demander permission pour les notifications
        if ('Notification' in window && Notification.permission === 'default') {
            setTimeout(() => {
                Notification.requestPermission().then(permission => {
                    console.log('üì¨ Permission notifications:', permission);
                });
            }, 5000); // Attendre 5 secondes apr√®s le chargement
        }

        // Analytics basiques pour PWA
        function trackPWAUsage(event, data = {}) {
            console.log('üìä PWA Event:', event, data);
            // Ici vous pourriez envoyer les donn√©es vers votre service d'analytics
        }

        // Tracker les √©v√©nements PWA importants
        if (window.matchMedia('(display-mode: standalone)').matches) {
            trackPWAUsage('app_launched_standalone');
        }
    </script>
</body>
</html>