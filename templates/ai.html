{% extends "base.html" %}

{% block title %}Coach IA - AI Fitness Coach{% endblock %}

{% block content %}
<div class="fade-in">
    <h1>ü§ñ Coach IA</h1>
    
    <div class="card">
        <h2>Cr√©ez votre programme personnalis√©</h2>
        <div class="card" style="padding: var(--spacing-md);">
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: var(--spacing-sm); color: var(--text-secondary);">
                    <span style="color: var(--accent);">‚Ä¢</span> Soyez pr√©cis dans vos objectifs
                </li>
                <li style="margin-bottom: var(--spacing-sm); color: var(--text-secondary);">
                    <span style="color: var(--accent);">‚Ä¢</span> Indiquez vos contraintes (temps, mat√©riel disponible)
                </li>
                <li style="margin-bottom: 0; color: var(--text-secondary);">
                    <span style="color: var(--accent);">‚Ä¢</span> N'h√©sitez pas √† demander des variantes ou alternatives
                </li>
            </ul>
        </div>        
        <form method="post" id="aiForm">
            <label for="prompt">D√©crivez vos objectifs :</label>
            <textarea 
                id="prompt" 
                name="prompt" 
                placeholder="Ex: Hypertrophie, 4 s√©ances par semaine, Full body, poids du corps"
                required
            ></textarea>
            <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                üöÄ G√©n√©rer mon programme
            </button>
        </form>
    </div>

    <!-- Indicateur de chargement -->
    <div class="card loading-container" id="loadingIndicator" style="display: none;">
        <div class="loading-content">
            <div class="ai-loader">
                <div class="loader-circle"></div>
                <div class="loader-circle"></div>
                <div class="loader-circle"></div>
            </div>
            <h3 style="color: var(--accent); margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm);">
                üß† Analyse de votre demande...
            </h3>
            <p style="color: var(--text-secondary); text-align: center; margin: 0;">
                L'IA g√©n√®re votre programme personnalis√©
            </p>
        </div>
    </div>

    {% if training_program_html %}
    <div class="card fade-in" id="programResult">
        <div class="program-header">
            <h2>üìã Votre Programme d'Entra√Ænement</h2>
            <button type="button" class="btn btn-secondary" onclick="openSaveModal()">
                üíæ Sauvegarder ce programme
            </button>
        </div>
        <div class="training-program-content">
            {{ training_program_html|safe }}
        </div>
    </div>
    
    <!-- Modal pour sauvegarder le programme -->
    <div id="saveModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíæ Sauvegarder le programme</h3>
                <button type="button" class="close-btn" onclick="closeSaveModal()">√ó</button>
            </div>
            <form id="saveProgramForm">
                <div class="form-group">
                    <label for="program_name">Nom du programme * :</label>
                    <input type="text" 
                           id="program_name" 
                           placeholder="Ex: Programme Force 12 semaines"
                           required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSaveModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </div>
            </form>
            <div id="saveMessage" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>
    {% endif %}
    
</div>

<style>
.loading-container {
    text-align: center;
    padding: var(--spacing-xxl) var(--spacing-lg);
}

.loading-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.ai-loader {
    display: flex;
    gap: var(--spacing-sm);
    margin: var(--spacing-lg) 0;
}

.loader-circle {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: linear-gradient(45deg, var(--accent), var(--accent-secondary));
    animation: bounce 1.4s infinite ease-in-out both;
}

.loader-circle:nth-child(1) {
    animation-delay: -0.32s;
}

.loader-circle:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes bounce {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.loading-container h3 {
    animation: pulse-text 2s infinite;
}

@keyframes pulse-text {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.6;
    }
}

.program-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.program-header h2 {
    margin: 0;
}

/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
}

.modal-content {
    background: var(--secondary);
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.close-btn {
    background: none;
    border: none;
    font-size: 32px;
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    transition: all 0.2s ease;
}

.close-btn:hover {
    color: var(--accent);
    transform: rotate(90deg);
}

.modal-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.modal-actions button {
    flex: 1;
}

#saveMessage {
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
}

#saveMessage.success {
    background: var(--success);
    color: white;
}

#saveMessage.error {
    background: var(--danger);
    color: white;
}

@media (max-width: 768px) {
    .program-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .modal-content {
        padding: 20px;
    }
}
</style>

<script>
// Variables globales pour stocker le contenu du programme
let programContent = '';

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('aiForm');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    
    // Stocker le contenu du programme si pr√©sent
    const programResult = document.getElementById('programResult');
    if (programResult) {
        programContent = programResult.querySelector('.training-program-content').innerHTML;
    }

    form.addEventListener('submit', function(e) {
        // Afficher l'indicateur de chargement
        loadingIndicator.style.display = 'block';
        
        // Modifier le bouton
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ G√©n√©ration en cours...';
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';

        // Scroll vers l'indicateur de chargement
        setTimeout(() => {
            loadingIndicator.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    });
});

function openSaveModal() {
    document.getElementById('saveModal').style.display = 'flex';
}

function closeSaveModal() {
    document.getElementById('saveModal').style.display = 'none';
    document.getElementById('saveMessage').style.display = 'none';
}

document.getElementById('saveProgramForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const nom = document.getElementById('program_name').value.trim();
    const messageDiv = document.getElementById('saveMessage');
    
    // Pr√©parer les donn√©es
    const formData = new FormData();
    formData.append('nom', nom);
    formData.append('programme_text', programContent);
    
    try {
        const response = await fetch('/programme/save-from-ai', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        messageDiv.style.display = 'block';
        if (result.success) {
            messageDiv.className = 'success';
            messageDiv.textContent = '‚úÖ ' + result.message;
            
            // Rediriger apr√®s 2 secondes
            setTimeout(() => {
                window.location.href = '/programme';
            }, 2000);
        } else {
            messageDiv.className = 'error';
            messageDiv.textContent = '‚ùå ' + result.message;
        }
    } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.className = 'error';
        messageDiv.textContent = '‚ùå Erreur lors de la sauvegarde: ' + error.message;
    }
});
</script>
{% endblock %}